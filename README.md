# Human–Robot Trust Modelling Framework (MATLAB)

This repository contains the full implementation of a computational trust model developed for a TU Delft MSc thesis in Aerospace Engineering (Control & Simulation track). It models how humans form and update trust in an autonomous search-and-rescue (SAR) drone, based on:

- **Dispositional trust** (pre-existing attitude)
- **Latent trust drift** toward/away from a personal anchor
- **Reputation effects** from prior collective information
- **Situational trust** influenced by perceived risk and self-confidence
- **Personal experience** influenced by personal experience (success/failure streaks)

## 1. High‑Level System Overview

This codebase implements a full end‑to‑end pipeline for modelling **human trust in a robot** in a **search and rescue (SAR)** scenario. It includes:

- **Preprocessing** of raw CSV event logs into structured participant data.
- **Measurement mapping & weighting** (steps M1–M6) to align trust instruments.
- **Simulation** of the continuous‑time trust model decomposed into:
  - dispositional trust,
  - latent trust,
  - situational trust,
  - reputation dynamics,
  - personal experience.
- **Model fitting** using WLS with multiple solvers (fmincon / GA / patternsearch).
- **Diagnostics & validation** including residual analysis and trajectory plots.
- **Optional train/validation split** so the model can be fitted on a subset of participants and evaluated on held-out participants.

The full pipeline can reproduce the published results and can be executed on new datasets with no modification. The repository is structured in the following way:

```
root/
│
├─ main.m                                – Entry point (runs preprocessing + postprocessing)
│
├─ src/
│   ├─ fit_trust_parameters.m            – Global parameter estimation (WLS + selectable solver backend)
│   ├─ run_trust_optimisation_pipeline.m – Orchestrates the 4-stage fitting pipeline with checkpointing + run archival
│   ├─ preprocessing.m                   – Steps 1–4 + time alignment (T1)
│   ├─ postprocessing.m                  – Measurement mapping & M1–M6 calibration
│   ├─ cost_functions/                   – Cost functions and optimisation glue
│   ├─ diagnostics/                      – Plotting, simulation inspection, residuals
│   ├─ measurement/                      – Mapping, scaling, LOPO weighting
│   ├─ optimization_methods/             – Solver-specific implementations (fmincon/GA/patternsearch)
│   ├─ preprocessing/                    – Raw → participants struct
│   └─ trust_model/                      – Trust dynamics, simulator, parameter maps
│
├─ derived/                              – Intermediate files generated by the pipeline
└─ docs/                                 – Full technical documentation (see below)
```
---


## 2. Developer‑Oriented Overview

This section explains the internal architecture and how modules interact.

### 2.1 Architecture Summary


```
raw CSV logs
     ↓ preprocessing (steps 1-4, T1)
participant structs (cleaned, validated, timestamped)
     ↓ (optional) step V
training set / validation set (participant split)
     ↓ measurement mapping (steps M1-M6)
scaled trust measurements + probe mapping + weights
     ↓ trust model simulation
continuous trust trajectories
     ↓ optimization
best‑fit parameters θ using WLS + fmincon / GA / patternsearch
     ↓ diagnostics
residual plots, per‑participant analyses, optional train vs validation checks
```

The system is split into four logical layers:

1. **Preprocessing Layer** – converts raw experiment logs into structured MATLAB participant objects.
2. **Participant Splitting Layer (optional)** – splits participants into training and validation sets by index.
3. **Measurement Layer** – harmonises trust measurement scales and generates weights.
4. **Trust Model Layer** – defines the dynamic model, performs simulation, and computes the WLS cost.
5. **Diagnostics Layer** – tools for inspecting model behaviour and quality of fit.

---

## 3. Preprocessing Pipeline

This stage takes raw CSV logs and produces validated participant structs with all fields aligned.

### 3.1 Step-by-step

| Step | Script | Purpose |
|------|--------|---------|
| 1 | `step1_loader.m` | Loads and normalizes raw event tables. |
| 2 | `step2_build_participants.m` | Builds structured participant objects. |
| 3 | `step3_validate.m` | Validates consistency (timeline order, probes, questionnaires). |
| 4 | `step4_filter_participants.m` | Removes participants failing minimal requirements. |
| T1 | `stepT1_add_times.m` | Adds absolute time grid + event timestamps. |
| V | `stepV_split_train_valid.m` | Optional: splits participants into training and validation sets. |

### 3.2 Internal support functions

These scripts perform low‑level tasks such as JSON decoding, timeline sorting, computing block indices, parsing questionnaire entries, etc. Examples:

- `normalize_headers.m` – consistent column names across data sources.
- `decode_json_columns.m` – safely parse JSON blobs.
- `extract_door_trials.m` – parse door recommendation, risk, outcome.
- `extract_trust_probes.m` – extract and link trust probe responses.
- `check_*` scripts – enforce structural validity.

The pipeline output is a file such as:

```
derived/participants_time_stepT1.mat
```

If Step V is skipped, this file is the **input to the model fitting pipeline**. If Step V is used, two additional files are obtained such as:

```
derived/participants_time_train_stepV.mat
derived/participants_time_valid_stepV.mat
```

The training file is then used as **input to the model fitting pipeline**, and the validation file is used for **out-of-sample diagnostics**.

---

## 4. Measurement Mapping & Weighting (M1–M6)

Trust is measured via:

1. 40‑item questionnaire (pre/post)
2. 14‑item questionnaire (two midblocks)
3. Repeated 1‑item probes

Because these instruments operate on different scales, steps M1–M6 align them.

### 4.1 Summary of mapping/weighting steps

| Step | File | Purpose |
|------|------|---------|
| M1 | `stepM1_14item_lopo.m` | LOPO calibration for 14‑item questionnaire. |
| M2 | `stepM2_apply_14mapping.m` | Applies global 14→40 mapping. |
| M3 | `stepM3_probe_calibration.m` | Calibrates probe→40 scale mapping. |
| M4 | `stepM4_apply_probe_mapping.m` | Applies mapping to all probes. |
| M5 | `stepM5_save_measurement_weights.m` | Generates weights struct used in WLS. |
| M6 | `stepM6_reputation_bias.m` | Optional correction for review‑based bias. |

Output:

```
derived/participants_probes_mapped_stepM4.mat
derived/measurement_weights.mat
```

The weights file provides:

- `w40` – weight of 40‑item measurement  
- `w14` – weight of 14‑item measurement  
- `w_probe` – weight of single trust probes  

Used everywhere in WLS evaluation and diagnostics.

---

## 5. Trust Model Dynamics

### 5.1 Overview

Trust is modelled as a sum of multiple cognitive components:

#### Total Trust
\[
\tau(t) = \tau_{\text{lat}}(t) + \tau_{\text{rep}}(t) + \tau_{\text{sit}}(r(t))
\quad \text{clipped to } [0,1]
\]

#### 1. Dispositional trust (τ_disp)
A static anchor in \([0,1]\), derived from a pre-interaction 40-item questionnaire.

#### 2. Latent trust drift (τ_lat)
A slow process that drifts toward τ_disp between door events and is updated by personal-experience outcomes during the interaction.

#### 3. Personal experience updates
Each door event shifts τ_lat depending on streaks of successes or failures.

#### 4. Reputation (τ_rep)
Initial reaction to an online-review prime, decaying exponentially toward zero.

#### 5. Situational trust (τ_sit)
Instant response to current **risk value** (0–1) and participant **self-confidence (sc)**.


### 5.2 Core trust model functions

| File | Description |
|------|-------------|
| `trust_compute_dispositional.m` | Reads τ_disp from questionnaires. |
| `trust_compute_situational.m` | Computes τ_sit from risk, τ_disp, self-confidence. |
| `trust_update_reputation.m` | Exponential decay model for τ_rep. |
| `trust_update_personal_experience.m` | Event-based update (success/failure streak). |
| `trust_prepare_latent_sequence.m` | Initiates latent drift episode after an event. |
| `trust_update_latent_sequence.m` | Time evolution of latent trust. |
| `trust_init_state.m` | Builds initial trust state for a participant. |
| `trust_step.m` | Performs a single simulation step. |
| `trust_simulate_or_predict_one_participant.m` | Runs full simulation over time grid. |

Parameter mapping utilities:

- `trust_theta_to_params.m`

### 5.3 Simulation output

Each participant simulation produces:

- Full trust trajectory τ(t)
- τ_lat(t), τ_rep(t), τ_sit(t)
- Risk timeline
- Model predictions `y_hat` at measurement times

Used for WLS cost evaluation.

---

## 6. Model Fitting and Optimization

### 6.1 Cost functions

| File | Purpose |
|------|---------|
| `trust_cost_one_participant.m` | WLS cost for one participant. |
| `trust_cost_all.m` | Sum of costs over all participants. |

### 6.2 Optimization driver

```
fit_trust_parameters.m
```

This script:

1. Loads participant structs and weights.
2. Defines bounds & parameter initial guess.
3. Calls a selectable solver implementation (fmincon / GA / patternsearch) on `trust_cost_all`.
4. Saves best‑fit parameters θ.

Solver implementations are located in:

```
src/optimization_methods/
```
Detailed documentation is provided in `docs/05_optimization_methods.md`.

### 6.3 Recommended fitting workflow

```
run_trust_optimisation_pipeline.m
```

This script:

- Runs planned 4 model fit runs (GA → GA → `fmincon` → `patternsearch`).
- Saves checkpoints after each stage.
- Writes final outputs to a dedicated run folder.
- Archives old run logs automatically.

Minimal example:

```matlab
cfg.dt = 1.0;
cfg.theta0 = theta0;
cfg.run_tag = "train25";
results = run_trust_optimisation_pipeline(cfg);
```

This pipeline will result in log files under `derived`:

- `derived/fit_runs/<run_id>/final/*.mat` – solver outputs per stage + run_summary
- `derived/fit_runs/<run_id>/logs/pipeline.log` – full console log
- `derived/fit_runs/<run_id>/checkpoints/*.mat` – intermediate checkpoints (deleted after success)
- `derived/fit_runs/old/` – archived past runs

### 6.4 Debugging tools

- `measure_trust_cost_runtime.m` – benchmark cost runtime.  
- `debug_cost_gradient.m` – inspect gradients.  

---

## 7. Diagnostics & Evaluation

### 7.1 Global residual diagnostics

`trust_residual_diagnostics.m`:

- Computes residuals y_obs − y_hat across all participants.
- Groups by instrument type.
- Computes summary statistics.
- Generates diagnostic plots:
  - Histogram of residuals
  - Boxplots by measurement type
  - Residual vs predicted
  - Residual vs time

### 7.2 Per‑participant diagnostics

`run_trust_diagnostics.m`:

- Simulates model trajectory for one participant.
- Plots all trust components.
- Overlays model predictions on observed measurements.

### 7.3 Sanity checks

- `sanity_check_trust_cost.m` – per-participant cost contributions.  
- `test_trust_modules.m` – isolated tests for core update rules.

---

## 8. Reproducing the Full Pipeline

### 8.1 Preprocessing

```matlab
preprocessing
```

Produces:

- `participants_clean_step4.mat`
- `participants_time_stepT1.mat`

### 8.2 Train/Validation Split

```matlab
stepV_split_train_valid
```

Produces:

- `participants_time_train_stepV.mat`
- `participants_time_valid_stepV.mat`

### 8.3 Measurement mapping

```matlab
postprocessing
```

Produces:

- `participants_probes_mapped_stepM4.mat`
- `measurement_weights.mat`

### 8.4 Fit model

```matlab
fit_trust_parameters(method, dt, preset, theta0)
```

Allowed methods (string):
- "fmincon"
- "ga"
- "patternsearch"

Solver preset name is optional and method-dependent (GA or patternsearch).

Optional initial parameter guess theta0 (8x1 vector). If provided, it is used to initialise the solver.

Outputs:

- best‑fit θ
- residual plots
- diagnostics

### 8.5 Example: simulate one participant

```matlab
sim = trust_simulate_one_participant(theta, participant(idx), dt);
plot(sim.t_grid, sim.tau_hist)
```

### 8.6 Example: Plot model components for a single participant

```matlab
run_trust_diagnostics(participant_index, dt, theta)
```

### 8.7 Example: Global residual analysis

```matlab
trust_residual_diagnostics(best_theta)
```


---

## 9. Folder Structure Summary

```
/ (repo root)
│
├─ main.m
├─ INDEX.md
│
├─ src/
│   ├─ fit_trust_parameters.m
│   ├─ run_trust_optimisation_pipeline.m
│   ├─ preprocessing.m
│   ├─ postprocessing.m
│   ├─ cost_functions/
│   ├─ diagnostics/
│   ├─ measurement_mapping/
│   ├─ optimization_methods/
│   ├─ preprocessing/
│   └─ trust_model/
│
├─ derived/
│   ├─ participants_clean_step4.mat
│   ├─ participants_time_stepT1.mat
│   ├─ participants_time_train_stepV.mat
│   ├─ participants_time_valid_stepV.mat
│   ├─ participants_probes_mapped_stepM4.mat
│   ├─ measurement_weights.mat
│   └─ fit_runs/
│
└─ docs/
    ├─ 01_preprocessing.md
    ├─ 02_measurement_mapping_and_weights.md
    ├─ 03_trust_model.md
    ├─ 04_cost_optimisation.md
    ├─ 05_optimization_methods.md
    └─ 06_diagnostics.md
```

---

## 10. How to Extend the Framework

### Adding new measurements
Add extraction + mapping scripts, then update measurement_weights.

### Adding new model components
Implement new update function → include inside `trust_step.m`.

### Fitting new parameters
Extend θ layout → update mapping functions → run WLS again.

---

## 11. Installation & Requirements

### MATLAB Version
- Recommended: MATLAB R2022b or newer  
- Required toolboxes:
  - Optimization Toolbox  
  - Statistics and Machine Learning Toolbox  
  - Global Optimization Toolbox (for GA and patternsearch)
  - Parallel Computing Toolbox (optional, for parallel optimization)

### Folder Requirements
Place raw data in:

```
data/raw_events/*.csv
```

Intermediate files will be written automatically to `derived/`.

---

## 12. Citation

If you use this framework in academic work, please cite:

> Silva, P. (2025). *Computational Modelling of Human Trust in Search-and-Rescue Human–Robot Teams.* MSc Thesis, Delft University of Technology.

---

## 13. Author

**Pedro Rodrigues Correia da Silva**  
MSc Aerospace Engineering — Control & Simulation Track  
Delft University of Technology (TU Delft)  
E-mail: [P.RodriguesCorreiaDaSilva@student.tudelft.nl](mailto:P.RodriguesCorreiaDaSilva@student.tudelft.nl)
